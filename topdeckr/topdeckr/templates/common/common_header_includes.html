<!-- Javascript Here -->
<link href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="{{ STATIC_URL }}js/gatherer_helper.js"></script>
<script type="text/javascript">
	$().ready(function() {

        function handleCardSearch(event) {
            var keyupOverrides = [27, 37, 38, 39, 40];
            if( keyupOverrides.indexOf(event.keyCode) > -1 ){
                event.preventDefault();
                return false;
            }
            //Open the detail search panel with <enter>
            if( event.keyCode == 13 ){
                event.preventDefault();
                ajaxRequest('get_card', {'id': $('.card-result.selected').attr('card-id')}, handleGetCard);
                $('.sub-right-pullout').fadeIn(100);
                $('.sub-right-pullout').addClass('extended');
                return false;
            }
            // Set Timeout
            clearTimeout($.data(this, 'timer'));

            // Set Search String
            var search_string = $(this).val();

            // Do Search
            if (search_string == '') {}
            else
                $(this).data('timer', setTimeout(search, 100));
        }

		$('body').on('keydown', function(event){
            switch(event.which)
            {
                //Open the search panel with <left-arrow>
                case 37:
                    $('.right-pullout').fadeIn(100);
                    $('.right-pullout').addClass('extended');
                    $('#card-name').focus();
                    $('#card-name').on('keyup', handleCardSearch);
                    break;
                //Close the last panel that was opened <esc>
                case 27:
                    var panel_to_affect = $('.sub-right-pullout').hasClass('extended') ? '.sub-right-pullout' : '.right-pullout';
                    $(panel_to_affect).fadeOut(100);
                    $(panel_to_affect).removeClass('extended');
                    if(panel_to_affect == ".right-pullout"){
                        $('#card-name').blur().off('keyup', handleCardSearch).val('');
                        $('.card-result').remove();
                    }
                    if(panel_to_affect == ".sub-right-pullout"){
                        $('.card-information').empty();
                    }
                    break;
                //Open the detail search panel with <enter>
                case 13:
                    event.preventDefault();
                    break;

                case 40:
                    event.preventDefault();
                    if(!$('.card-result.selected').length){
                        $('.card-result').each(function(index, element){
                            $(element).addClass('selected');
                            return false;
                        });
                    }
                    else{
                        var add_to_next = false;
                        $('.card-result').each(function(index, element){
                            if(add_to_next){
                                $(element).addClass('selected');
                                return false;
                            }
                            if($(element).hasClass('selected'))
                            {
                                $(element).removeClass('selected');
                                add_to_next = true;
                            }
                        });
                    }
                    break;

                case 38:
                    event.preventDefault();
                    if(!$('.card-result.selected').length){
                        $($('.card-result').get().reverse()).each(function(index, element){
                            $(element).addClass('selected');
                            return false;
                        });
                    }
                    else{
                        var add_to_next = false;
                        $($('.card-result').get().reverse()).each(function(index, element){
                            if(add_to_next){
                                $(element).addClass('selected');
                                return false;
                            }
                            if($(element).hasClass('selected'))
                            {
                                $(element).removeClass('selected');
                                add_to_next = true;
                            }
                        });
                    }
                    break;
            }
		});
	});

	function search()
	{	
		var search_value = $('#card-name').val();
		if(search_value !== '')
		{
			ajaxRequest('search_cards', {'query': search_value, 'field': 'name', 'limit': 25}, handleCardSearchData);
		}
		return false;
	}

	function ajaxRequest(operation, data, handler){	
		$.ajax({url: "/request/" + operation + "/",
			data:data,
			type: 'POST',
			cache: false,
			success: handler});
	}

    function handleGetCard(result){
        var card_info_html = '';

        card_info_html += '<div class="name">' + result.name + '</div>';
        card_info_html += '<img class="image" src="' + getWizardsSrc(result.name) + '" />';

        $('.card-information').html(card_info_html);
    }

    function processColor(mana_cost){
        var color = "";
        if(mana_cost.indexOf('W') != -1)
            color = '#FFF';
        if(mana_cost.indexOf('U') != -1){
            if(color.length)
                return '#E0AC10'
            color = '#00F';
        }
        if(mana_cost.indexOf('G') != -1){
            if(color.length)
                return '#E0AC10'
            color = '#1D8700';
        }
        if(mana_cost.indexOf('R') != -1){
            if(color.length)
                return '#E0AC10'
            color = '#F00';
        }
        if(mana_cost.indexOf('B') != -1){
            if(color.length)
                return '#E0AC10'
            color = '#444';
        }
        if(!color.length)
            color = '#CCC';
        return color;
    }

	function handleCardSearchData(result){
        var cards_returned = JSON.parse(result).cards;
        console.log(cards_returned);
        var card_display = $('.card-search');
        $('.card-result').remove();
        for(var card in cards_returned){
            card_display.hide().append("<div class='card-result' card-id=" + cards_returned[card].id +
                    " style='border-left:solid 2px " + processColor(cards_returned[card].mana_cost) + ";'>" +
                    "<div class='name'>" +
                    cards_returned[card].name +
                    "</div>" +
                    "<div class='type'>" +
                    cards_returned[card].type +
                    "</div>" +
                    "<div class='set-name'>" +
                    cards_returned[card].set_name +
                    "</div>" +
                    "</div>").fadeIn(100);
        }
	}
</script>

<!-- CSS Here -->
<link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}css/main.css" />
